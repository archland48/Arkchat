import { NextRequest } from "next/server";
import { getBibleVerse, parseBookName } from "@/lib/fhl-api";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";

/**
 * Daily Verse API
 * Returns a verse based on the current date (deterministic)
 * This ensures the same verse is returned for the same date
 */
export async function GET(req: NextRequest) {
  try {
    const searchParams = req.nextUrl.searchParams;
    const date = searchParams.get("date"); // Optional: YYYY-MM-DD format
    const version = searchParams.get("version") || "unv";
    const simplified = searchParams.get("simplified") === "1";

    // Use provided date or current date
    const targetDate = date ? new Date(date) : new Date();
    const dateStr = targetDate.toISOString().split("T")[0]; // YYYY-MM-DD
    
    // Generate a deterministic verse based on date
    // Using day of year (1-365/366) to cycle through verses
    const startOfYear = new Date(targetDate.getFullYear(), 0, 1);
    const dayOfYear = Math.floor(
      (targetDate.getTime() - startOfYear.getTime()) / (1000 * 60 * 60 * 24)
    ) + 1;

    // Predefined list of popular verses (you can customize this)
    // Format: [bookId, chapter, verse]
    const dailyVerses: Array<[number, number, number]> = [
      [43, 3, 16], // 約翰福音 3:16
      [40, 5, 3],  // 馬太福音 5:3
      [40, 5, 4],  // 馬太福音 5:4
      [40, 5, 5],  // 馬太福音 5:5
      [40, 5, 6],  // 馬太福音 5:6
      [40, 5, 7],  // 馬太福音 5:7
      [40, 5, 8],  // 馬太福音 5:8
      [40, 5, 9],  // 馬太福音 5:9
      [40, 5, 10], // 馬太福音 5:10
      [40, 5, 11], // 馬太福音 5:11
      [40, 5, 12], // 馬太福音 5:12
      [40, 6, 9],  // 馬太福音 6:9
      [40, 6, 10], // 馬太福音 6:10
      [40, 6, 11], // 馬太福音 6:11
      [40, 6, 12], // 馬太福音 6:12
      [40, 6, 13], // 馬太福音 6:13
      [40, 6, 14], // 馬太福音 6:14
      [40, 6, 15], // 馬太福音 6:15
      [40, 6, 19], // 馬太福音 6:19
      [40, 6, 20], // 馬太福音 6:20
      [40, 6, 21], // 馬太福音 6:21
      [40, 6, 25], // 馬太福音 6:25
      [40, 6, 26], // 馬太福音 6:26
      [40, 6, 27], // 馬太福音 6:27
      [40, 6, 28], // 馬太福音 6:28
      [40, 6, 33], // 馬太福音 6:33
      [40, 6, 34], // 馬太福音 6:34
      [40, 7, 7],  // 馬太福音 7:7
      [40, 7, 8],  // 馬太福音 7:8
      [40, 7, 12], // 馬太福音 7:12
      [40, 11, 28], // 馬太福音 11:28
      [40, 11, 29], // 馬太福音 11:29
      [40, 11, 30], // 馬太福音 11:30
      [40, 16, 24], // 馬太福音 16:24
      [40, 16, 25], // 馬太福音 16:25
      [40, 16, 26], // 馬太福音 16:26
      [40, 19, 26], // 馬太福音 19:26
      [40, 22, 37], // 馬太福音 22:37
      [40, 22, 38], // 馬太福音 22:38
      [40, 22, 39], // 馬太福音 22:39
      [40, 28, 18], // 馬太福音 28:18
      [40, 28, 19], // 馬太福音 28:19
      [40, 28, 20], // 馬太福音 28:20
      [41, 10, 27], // 馬可福音 10:27
      [42, 1, 37],  // 路加福音 1:37
      [42, 2, 14],  // 路加福音 2:14
      [42, 6, 27],  // 路加福音 6:27
      [42, 6, 28],  // 路加福音 6:28
      [42, 6, 35],  // 路加福音 6:35
      [42, 9, 23],  // 路加福音 9:23
      [42, 9, 24],  // 路加福音 9:24
      [42, 10, 27], // 路加福音 10:27
      [42, 11, 9],  // 路加福音 11:9
      [42, 11, 10], // 路加福音 11:10
      [42, 12, 15], // 路加福音 12:15
      [42, 12, 22], // 路加福音 12:22
      [42, 12, 23], // 路加福音 12:23
      [42, 12, 24], // 路加福音 12:24
      [42, 12, 31], // 路加福音 12:31
      [42, 12, 32], // 路加福音 12:32
      [42, 12, 34], // 路加福音 12:34
      [42, 17, 6],  // 路加福音 17:6
      [42, 18, 27], // 路加福音 18:27
      [42, 23, 34], // 路加福音 23:34
      [43, 1, 1],   // 約翰福音 1:1
      [43, 1, 12],  // 約翰福音 1:12
      [43, 1, 14],  // 約翰福音 1:14
      [43, 3, 3],   // 約翰福音 3:3
      [43, 3, 5],   // 約翰福音 3:5
      [43, 3, 16],  // 約翰福音 3:16
      [43, 3, 17],  // 約翰福音 3:17
      [43, 3, 18],  // 約翰福音 3:18
      [43, 4, 24],  // 約翰福音 4:24
      [43, 6, 35],  // 約翰福音 6:35
      [43, 8, 12],  // 約翰福音 8:12
      [43, 8, 32],  // 約翰福音 8:32
      [43, 10, 10], // 約翰福音 10:10
      [43, 10, 11], // 約翰福音 10:11
      [43, 10, 27], // 約翰福音 10:27
      [43, 10, 28], // 約翰福音 10:28
      [43, 11, 25], // 約翰福音 11:25
      [43, 11, 26], // 約翰福音 11:26
      [43, 13, 34], // 約翰福音 13:34
      [43, 13, 35], // 約翰福音 13:35
      [43, 14, 1],  // 約翰福音 14:1
      [43, 14, 2],  // 約翰福音 14:2
      [43, 14, 3],  // 約翰福音 14:3
      [43, 14, 6],  // 約翰福音 14:6
      [43, 14, 13], // 約翰福音 14:13
      [43, 14, 14], // 約翰福音 14:14
      [43, 14, 15], // 約翰福音 14:15
      [43, 14, 16], // 約翰福音 14:16
      [43, 14, 17], // 約翰福音 14:17
      [43, 14, 21], // 約翰福音 14:21
      [43, 14, 23], // 約翰福音 14:23
      [43, 14, 26], // 約翰福音 14:26
      [43, 14, 27], // 約翰福音 14:27
      [43, 15, 1],  // 約翰福音 15:1
      [43, 15, 2],  // 約翰福音 15:2
      [43, 15, 3],  // 約翰福音 15:3
      [43, 15, 4],  // 約翰福音 15:4
      [43, 15, 5],  // 約翰福音 15:5
      [43, 15, 7],  // 約翰福音 15:7
      [43, 15, 8],  // 約翰福音 15:8
      [43, 15, 9],  // 約翰福音 15:9
      [43, 15, 10], // 約翰福音 15:10
      [43, 15, 11], // 約翰福音 15:11
      [43, 15, 12], // 約翰福音 15:12
      [43, 15, 13], // 約翰福音 15:13
      [43, 15, 14], // 約翰福音 15:14
      [43, 15, 15], // 約翰福音 15:15
      [43, 15, 16], // 約翰福音 15:16
      [43, 15, 17], // 約翰福音 15:17
      [43, 16, 13], // 約翰福音 16:13
      [43, 16, 14], // 約翰福音 16:14
      [43, 16, 15], // 約翰福音 16:15
      [43, 16, 23], // 約翰福音 16:23
      [43, 16, 24], // 約翰福音 16:24
      [43, 16, 33], // 約翰福音 16:33
      [43, 17, 3],  // 約翰福音 17:3
      [43, 17, 17], // 約翰福音 17:17
      [43, 17, 20], // 約翰福音 17:20
      [43, 17, 21], // 約翰福音 17:21
      [43, 17, 22], // 約翰福音 17:22
      [43, 17, 23], // 約翰福音 17:23
      [43, 20, 28], // 約翰福音 20:28
      [43, 20, 29], // 約翰福音 20:29
      [43, 20, 31], // 約翰福音 20:31
      [44, 1, 8],   // 使徒行傳 1:8
      [44, 2, 38],  // 使徒行傳 2:38
      [44, 4, 12],  // 使徒行傳 4:12
      [44, 16, 31], // 使徒行傳 16:31
      [45, 1, 16],  // 羅馬書 1:16
      [45, 1, 17],  // 羅馬書 1:17
      [45, 3, 23],  // 羅馬書 3:23
      [45, 3, 24],  // 羅馬書 3:24
      [45, 5, 1],   // 羅馬書 5:1
      [45, 5, 8],   // 羅馬書 5:8
      [45, 5, 9],   // 羅馬書 5:9
      [45, 6, 23],  // 羅馬書 6:23
      [45, 8, 1],   // 羅馬書 8:1
      [45, 8, 2],   // 羅馬書 8:2
      [45, 8, 3],   // 羅馬書 8:3
      [45, 8, 4],   // 羅馬書 8:4
      [45, 8, 5],   // 羅馬書 8:5
      [45, 8, 6],   // 羅馬書 8:6
      [45, 8, 7],   // 羅馬書 8:7
      [45, 8, 8],   // 羅馬書 8:8
      [45, 8, 9],   // 羅馬書 8:9
      [45, 8, 10],  // 羅馬書 8:10
      [45, 8, 11],  // 羅馬書 8:11
      [45, 8, 14],  // 羅馬書 8:14
      [45, 8, 15],  // 羅馬書 8:15
      [45, 8, 16],  // 羅馬書 8:16
      [45, 8, 17],  // 羅馬書 8:17
      [45, 8, 18],  // 羅馬書 8:18
      [45, 8, 26],  // 羅馬書 8:26
      [45, 8, 27],  // 羅馬書 8:27
      [45, 8, 28],  // 羅馬書 8:28
      [45, 8, 29],  // 羅馬書 8:29
      [45, 8, 30],  // 羅馬書 8:30
      [45, 8, 31],  // 羅馬書 8:31
      [45, 8, 32],  // 羅馬書 8:32
      [45, 8, 33],  // 羅馬書 8:33
      [45, 8, 34],  // 羅馬書 8:34
      [45, 8, 35],  // 羅馬書 8:35
      [45, 8, 36],  // 羅馬書 8:36
      [45, 8, 37],  // 羅馬書 8:37
      [45, 8, 38],  // 羅馬書 8:38
      [45, 8, 39],  // 羅馬書 8:39
      [45, 10, 9],  // 羅馬書 10:9
      [45, 10, 10], // 羅馬書 10:10
      [45, 10, 11], // 羅馬書 10:11
      [45, 10, 13], // 羅馬書 10:13
      [45, 10, 14], // 羅馬書 10:14
      [45, 10, 15], // 羅馬書 10:15
      [45, 10, 17], // 羅馬書 10:17
      [45, 12, 1],  // 羅馬書 12:1
      [45, 12, 2],  // 羅馬書 12:2
      [45, 12, 3],  // 羅馬書 12:3
      [45, 12, 4],  // 羅馬書 12:4
      [45, 12, 5],  // 羅馬書 12:5
      [45, 12, 6],  // 羅馬書 12:6
      [45, 12, 7],  // 羅馬書 12:7
      [45, 12, 8],  // 羅馬書 12:8
      [45, 12, 9],  // 羅馬書 12:9
      [45, 12, 10], // 羅馬書 12:10
      [45, 12, 11], // 羅馬書 12:11
      [45, 12, 12], // 羅馬書 12:12
      [45, 12, 13], // 羅馬書 12:13
      [45, 12, 14], // 羅馬書 12:14
      [45, 12, 15], // 羅馬書 12:15
      [45, 12, 16], // 羅馬書 12:16
      [45, 12, 17], // 羅馬書 12:17
      [45, 12, 18], // 羅馬書 12:18
      [45, 12, 19], // 羅馬書 12:19
      [45, 12, 20], // 羅馬書 12:20
      [45, 12, 21], // 羅馬書 12:21
      [45, 13, 1],  // 羅馬書 13:1
      [45, 13, 2],  // 羅馬書 13:2
      [45, 13, 3],  // 羅馬書 13:3
      [45, 13, 4],  // 羅馬書 13:4
      [45, 13, 5],  // 羅馬書 13:5
      [45, 13, 6],  // 羅馬書 13:6
      [45, 13, 7],  // 羅馬書 13:7
      [45, 13, 8],  // 羅馬書 13:8
      [45, 13, 9],  // 羅馬書 13:9
      [45, 13, 10], // 羅馬書 13:10
      [45, 13, 11], // 羅馬書 13:11
      [45, 13, 12], // 羅馬書 13:12
      [45, 13, 13], // 羅馬書 13:13
      [45, 13, 14], // 羅馬書 13:14
      [45, 14, 1],  // 羅馬書 14:1
      [45, 14, 2],  // 羅馬書 14:2
      [45, 14, 3],  // 羅馬書 14:3
      [45, 14, 4],  // 羅馬書 14:4
      [45, 14, 5],  // 羅馬書 14:5
      [45, 14, 6],  // 羅馬書 14:6
      [45, 14, 7],  // 羅馬書 14:7
      [45, 14, 8],  // 羅馬書 14:8
      [45, 14, 9],  // 羅馬書 14:9
      [45, 14, 10], // 羅馬書 14:10
      [45, 14, 11], // 羅馬書 14:11
      [45, 14, 12], // 羅馬書 14:12
      [45, 14, 13], // 羅馬書 14:13
      [45, 14, 14], // 羅馬書 14:14
      [45, 14, 15], // 羅馬書 14:15
      [45, 14, 16], // 羅馬書 14:16
      [45, 14, 17], // 羅馬書 14:17
      [45, 14, 18], // 羅馬書 14:18
      [45, 14, 19], // 羅馬書 14:19
      [45, 14, 20], // 羅馬書 14:20
      [45, 14, 21], // 羅馬書 14:21
      [45, 14, 22], // 羅馬書 14:22
      [45, 14, 23], // 羅馬書 14:23
      [45, 15, 1],  // 羅馬書 15:1
      [45, 15, 2],  // 羅馬書 15:2
      [45, 15, 3],  // 羅馬書 15:3
      [45, 15, 4],  // 羅馬書 15:4
      [45, 15, 5],  // 羅馬書 15:5
      [45, 15, 6],  // 羅馬書 15:6
      [45, 15, 7],  // 羅馬書 15:7
      [45, 15, 8],  // 羅馬書 15:8
      [45, 15, 9],  // 羅馬書 15:9
      [45, 15, 10], // 羅馬書 15:10
      [45, 15, 11], // 羅馬書 15:11
      [45, 15, 12], // 羅馬書 15:12
      [45, 15, 13], // 羅馬書 15:13
      [45, 15, 14], // 羅馬書 15:14
      [45, 15, 15], // 羅馬書 15:15
      [45, 15, 16], // 羅馬書 15:16
      [45, 15, 17], // 羅馬書 15:17
      [45, 15, 18], // 羅馬書 15:18
      [45, 15, 19], // 羅馬書 15:19
      [45, 15, 20], // 羅馬書 15:20
      [45, 15, 21], // 羅馬書 15:21
      [45, 15, 22], // 羅馬書 15:22
      [45, 15, 23], // 羅馬書 15:23
      [45, 15, 24], // 羅馬書 15:24
      [45, 15, 25], // 羅馬書 15:25
      [45, 15, 26], // 羅馬書 15:26
      [45, 15, 27], // 羅馬書 15:27
      [45, 15, 28], // 羅馬書 15:28
      [45, 15, 29], // 羅馬書 15:29
      [45, 15, 30], // 羅馬書 15:30
      [45, 15, 31], // 羅馬書 15:31
      [45, 15, 32], // 羅馬書 15:32
      [45, 15, 33], // 羅馬書 15:33
      [45, 16, 1],  // 羅馬書 16:1
      [45, 16, 2],  // 羅馬書 16:2
      [45, 16, 3],  // 羅馬書 16:3
      [45, 16, 4],  // 羅馬書 16:4
      [45, 16, 5],  // 羅馬書 16:5
      [45, 16, 6],  // 羅馬書 16:6
      [45, 16, 7],  // 羅馬書 16:7
      [45, 16, 8],  // 羅馬書 16:8
      [45, 16, 9],  // 羅馬書 16:9
      [45, 16, 10], // 羅馬書 16:10
      [45, 16, 11], // 羅馬書 16:11
      [45, 16, 12], // 羅馬書 16:12
      [45, 16, 13], // 羅馬書 16:13
      [45, 16, 14], // 羅馬書 16:14
      [45, 16, 15], // 羅馬書 16:15
      [45, 16, 16], // 羅馬書 16:16
      [45, 16, 17], // 羅馬書 16:17
      [45, 16, 18], // 羅馬書 16:18
      [45, 16, 19], // 羅馬書 16:19
      [45, 16, 20], // 羅馬書 16:20
      [45, 16, 21], // 羅馬書 16:21
      [45, 16, 22], // 羅馬書 16:22
      [45, 16, 23], // 羅馬書 16:23
      [45, 16, 24], // 羅馬書 16:24
      [45, 16, 25], // 羅馬書 16:25
      [45, 16, 26], // 羅馬書 16:26
      [45, 16, 27], // 羅馬書 16:27
      // Add more verses to reach 365...
    ];

    // Select verse based on day of year (cycles through the list)
    const verseIndex = (dayOfYear - 1) % dailyVerses.length;
    const [bookId, chapter, verse] = dailyVerses[verseIndex];

    // Fetch the verse
    const result = await getBibleVerse(
      bookId,
      chapter,
      verse.toString(),
      version,
      false,
      simplified
    );

    // Format response for easy consumption
    const verseData = result.record?.[0];
    if (!verseData) {
      return new Response(
        JSON.stringify({ error: "Verse not found" }),
        { status: 404, headers: { "Content-Type": "application/json" } }
      );
    }

    const response = {
      date: dateStr,
      dayOfYear,
      reference: `${verseData.chineses} ${verseData.chap}:${verseData.sec}`,
      referenceEng: `${verseData.engs} ${verseData.chap}:${verseData.sec}`,
      text: verseData.bible_text,
      version: result.version || version,
      // For Shortcuts/widget use
      formatted: `${verseData.chineses} ${verseData.chap}:${verseData.sec}\n${verseData.bible_text}`,
      formattedEng: `${verseData.engs} ${verseData.chap}:${verseData.sec}\n${verseData.bible_text}`,
    };

    return new Response(JSON.stringify(response), {
      headers: {
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*", // Allow CORS for Shortcuts/widgets
      },
    });
  } catch (error: any) {
    console.error("Daily verse API error:", error);
    return new Response(
      JSON.stringify({
        error: error.message || "Failed to fetch daily verse",
      }),
      { status: 500, headers: { "Content-Type": "application/json" } }
    );
  }
}
