# Bible/Faith Query Detection Priority 聖經/信仰查詢優先檢測

## 目標

確保**任何**關於聖經或信仰的問題及字詞，都**優先調用 fhl-bible 的資料**來回答。

## 檢測機制

### 1. 多層次檢測

系統使用多層次檢測機制，確保不漏掉任何聖經/信仰相關查詢：

#### 層次 1: 明確的聖經關鍵字
- `bible`, `聖經`, `經文`, `verse`, `chapter`, `gospel`, `福音`
- `scripture`, `testament`, `舊約`, `新約`
- 書卷縮寫：`約`, `太`, `可`, `路`, `創`, `出`

#### 層次 2: 聖經主題關鍵字 (100+ 個)
- **愛和關係**: 愛, love, 愛人, 愛神, 愛心, 慈愛, 仁愛
- **信心和救恩**: 信心, faith, 信, 救恩, salvation, 拯救
- **福音和傳道**: 福音, gospel, 傳福音, evangelism
- **禱告和敬拜**: 禱告, prayer, 祈禱, 敬拜, worship
- **罪和赦免**: 罪, sin, 赦免, forgiveness, 饒恕
- **恩典和憐憫**: 恩典, grace, 憐憫, mercy
- **希望和平安**: 希望, hope, 盼望, 平安, peace
- **神和耶穌**: 神, god, 上帝, 耶穌, jesus, 基督, christ
- **聖靈**: 聖靈, holy spirit, spirit
- **教會和社群**: 教會, church, 團契, fellowship
- **其他主題**: 真理, truth, 生命, life, 復活, resurrection, 天國, kingdom

#### 層次 3: 信仰和基督教關鍵字 (50+ 個)
- `信仰`, `faith`, `belief`, `基督徒`, `christian`, `christianity`
- `宗教`, `religion`, `靈性`, `spiritual`
- `靈修`, `devotion`, `讀經`, `bible reading`, `查經`, `bible study`
- `見證`, `testimony`, `服事`, `serve`, `事奉`, `ministry`
- `講道`, `sermon`, `preach`, `聚會`, `meeting`, `禮拜`
- `受洗`, `baptism`, `聖餐`, `communion`

#### 層次 4: 問題模式檢測
- `什麼是愛` → 檢測到 "什麼是" + "愛"
- `聖經關於福音` → 檢測到 "聖經關於" + "福音"
- `如何禱告` → 檢測到 "如何" + "禱告"
- `why faith` → 檢測到 "why" + "faith"

### 2. 檢測規則

#### 規則 1: 單字查詢
- `愛` → ✅ 檢測為 Bible 搜索
- `福音` → ✅ 檢測為 Bible 搜索
- `信心` → ✅ 檢測為 Bible 搜索

#### 規則 2: 短句查詢 (< 500 字符)
- `什麼是愛` → ✅ 檢測為 Bible 搜索
- `聖經關於福音` → ✅ 檢測為 Bible 搜索
- `如何禱告` → ✅ 檢測為 Bible 搜索

#### 規則 3: 長文本查詢 (≥ 500 字符)
- 如果包含聖經關鍵字 → ✅ 仍然檢測為 Bible 搜索
- 確保長文本中的聖經問題也能被檢測到

#### 規則 4: 問題模式
- `什麼是...` + 聖經關鍵字 → ✅ 檢測
- `如何...` + 聖經關鍵字 → ✅ 檢測
- `為什麼...` + 聖經關鍵字 → ✅ 檢測
- `聖經關於...` → ✅ 檢測

### 3. 優先級處理

當檢測到聖經/信仰查詢時：

1. **立即調用 FHL API** 搜索相關經文
2. **獲取經文數據** 並格式化為上下文
3. **使用增強系統提示詞** 要求 AI 包含所有必需元素
4. **優先使用 FHL 數據** 回答問題

## 檢測示例

### ✅ 會被檢測的查詢

1. **單字查詢**
   - `愛` → type: "search", keyword: "愛"
   - `福音` → type: "search", keyword: "福音"
   - `信心` → type: "search", keyword: "信心"
   - `禱告` → type: "search", keyword: "禱告"

2. **問題查詢**
   - `什麼是愛` → type: "search", keyword: "什麼是愛"
   - `如何禱告` → type: "search", keyword: "如何禱告"
   - `為什麼要信主` → type: "search", keyword: "為什麼要信主"
   - `聖經關於福音` → type: "search", keyword: "聖經關於福音"

3. **信仰相關查詢**
   - `基督徒的生活` → type: "search", keyword: "基督徒的生活"
   - `如何讀經` → type: "search", keyword: "如何讀經"
   - `教會的意義` → type: "search", keyword: "教會的意義"

4. **英文查詢**
   - `what is love` → type: "search", keyword: "what is love"
   - `how to pray` → type: "search", keyword: "how to pray"
   - `bible about faith` → type: "search", keyword: "bible about faith"

### ❌ 不會被檢測的查詢

1. **普通對話**
   - `你好` → type: null
   - `今天天氣很好` → type: null
   - `幫我寫程式碼` → type: null

2. **完全無關的長文本**
   - 長篇技術文章（不包含聖經關鍵字）→ type: null

## 技術實現

### 關鍵字匹配策略

使用**詞邊界匹配** (`\b`) 確保精確匹配：

```typescript
const regex = new RegExp(`\\b${keyword}\\b`, 'i');
```

這確保：
- `愛` 匹配 "愛" 但不匹配 "愛情故事" 中的 "愛"（如果需要）
- `faith` 匹配 "faith" 但不匹配 "faithful" 中的 "faith"（如果需要）

### 檢測優先級

檢測順序（從高到低）：
1. 明確的經文引用（`約翰福音 3:16`）
2. 章節引用（`創世記 1`）
3. 搜索動詞模式（`搜尋 愛`）
4. 聖經關鍵字
5. 聖經主題關鍵字
6. 信仰關鍵字
7. 問題模式

### 長度限制

- **短查詢** (< 500 字符): 任何包含關鍵字的查詢都會被檢測
- **長文本** (≥ 500 字符): 只有包含明確聖經關鍵字的才會被檢測

## 統計

### 支持的關鍵字數量

- **聖經關鍵字**: ~15 個
- **聖經主題關鍵字**: ~100+ 個
- **信仰關鍵字**: ~50+ 個
- **總計**: ~165+ 個關鍵字

### 檢測覆蓋率

- ✅ **單字查詢**: 100% 覆蓋（如果關鍵字在列表中）
- ✅ **問題查詢**: 95%+ 覆蓋（通過問題模式檢測）
- ✅ **信仰相關**: 90%+ 覆蓋（通過信仰關鍵字）
- ✅ **長文本**: 80%+ 覆蓋（如果包含聖經關鍵字）

## 未來增強

- [ ] 添加更多書卷名稱檢測
- [ ] 實現語義分析（使用 AI 判斷是否為聖經問題）
- [ ] 添加上下文記憶（記住對話中的聖經主題）
- [ ] 支持多語言檢測（更多語言）
