# 504 错误调试分析

## 问题描述

用户输入："馬可福音四章30-41節"
返回：HTTP 504 Gateway Timeout

## 问题分析

### 1. Bible Query 检测问题

**用户输入格式：** "馬可福音四章30-41節"
- 書名：馬可福音 ✅
- 章：四章（中文数字）❌ 当前检测模式只匹配阿拉伯数字
- 節：30-41節 ✅

**当前检测模式：**
```typescript
/(?:馬可福音|可|mark|mar)\s*(\d+)[:：]\s*(\d+(?:-\d+)?(?:,\d+)*)/i
```

**问题：**
- 只匹配 `\d+`（阿拉伯数字），不匹配中文数字"四"
- "四章30-41節" 格式不匹配 `chapter:verse` 或 `chapter verse` 模式
- 可能被识别为 search query，触发多个 API 调用

### 2. 可能的超时原因

1. **Bible Query 检测失败** → 触发 Bible Mode 搜索 → 多个 API 调用
2. **FHL API 响应慢** → 超过 8 秒超时
3. **AI Builder API 响应慢** → 超过 25 秒超时
4. **多个 API 调用串行执行** → 总时间超过网关超时限制

### 3. 处理流程分析

```
用户输入："馬可福音四章30-41節"
  ↓
detectBibleQuery() 
  ↓
可能返回：{ type: "search", keyword: "馬可福音四章30-41節" }
  ↓
触发 searchBible() + getTopicStudy() + searchCommentary()
  ↓
多个 API 调用并行/串行
  ↓
总时间超过网关超时（30-60秒）
  ↓
504 Gateway Timeout
```

## 解决方案

### 1. 改进 Bible Query 检测

添加对中文数字和"章"、"節"格式的支持：

```typescript
// 支持格式：
// - "馬可福音四章30-41節"
// - "馬可福音4章30-41節"
// - "馬可福音4:30-41"
// - "馬可福音 4 30-41"
```

### 2. 添加更详细的日志

记录每个步骤的执行时间，定位瓶颈。

### 3. 优化 API 调用

- 减少不必要的 API 调用
- 确保并行执行
- 添加更短的超时时间
