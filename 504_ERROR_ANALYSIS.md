# 504 é”™è¯¯é—®é¢˜åˆ†æ

## é—®é¢˜æè¿°

ç”¨æˆ·è¾“å…¥ï¼š"é¦¬å¯ç¦éŸ³å››ç« 30-41ç¯€"
è¿”å›ï¼šHTTP 504 Gateway Timeout

## é—®é¢˜æ ¹æºåˆ†æ

### 1. Bible Query æ£€æµ‹é—®é¢˜ âœ… å·²ä¿®å¤

**é—®é¢˜ï¼š**
- "é¦¬å¯ç¦éŸ³å››ç« 30-41ç¯€" ä½¿ç”¨äº†ä¸­æ–‡æ•°å­—"å››ç« "
- ä¹‹å‰çš„æ£€æµ‹æ¨¡å¼åªåŒ¹é…é˜¿æ‹‰ä¼¯æ•°å­—ï¼ˆ`\d+`ï¼‰
- å¯¼è‡´æŸ¥è¯¢è¢«è¯¯åˆ¤ä¸º search queryï¼Œè§¦å‘å¤šä¸ª API è°ƒç”¨

**ä¿®å¤ï¼š**
- âœ… æ·»åŠ äº†å¯¹ä¸­æ–‡æ•°å­—çš„æ”¯æŒï¼ˆä¸€ã€äºŒã€ä¸‰ã€å››...ï¼‰
- âœ… æ·»åŠ äº†å¯¹"ç« "ã€"ç¯€"æ ¼å¼çš„æ”¯æŒ
- âœ… ç°åœ¨å¯ä»¥æ­£ç¡®è¯†åˆ«"é¦¬å¯ç¦éŸ³å››ç« 30-41ç¯€"

### 2. å¯èƒ½çš„è¶…æ—¶åŸå› 

#### A. Bible API è°ƒç”¨è¶…æ—¶
- **FHL API å“åº”æ…¢**ï¼šè¶…è¿‡ 8 ç§’è¶…æ—¶é™åˆ¶
- **å¤šä¸ª API è°ƒç”¨**ï¼šverse + word analysis + commentary + Strong's lookup
- **æ€»æ—¶é—´**ï¼šå¯èƒ½è¶…è¿‡ 30-40 ç§’

#### B. AI Builder API è¶…æ—¶
- **AI å“åº”æ…¢**ï¼šè¶…è¿‡ 25 ç§’è¶…æ—¶é™åˆ¶
- **Bible context å¤ªé•¿**ï¼šå¯¼è‡´ AI å¤„ç†æ—¶é—´å¢åŠ 

#### C. ç½‘å…³è¶…æ—¶
- **éƒ¨ç½²å¹³å°é™åˆ¶**ï¼šé€šå¸¸ 30-60 ç§’
- **æ€»å¤„ç†æ—¶é—´**ï¼šBible API (8s) + AI API (25s) = 33s+ï¼Œæ¥è¿‘é™åˆ¶

### 3. å¤„ç†æµç¨‹ï¼ˆå¯èƒ½å¯¼è‡´è¶…æ—¶ï¼‰

```
ç”¨æˆ·è¾“å…¥ï¼š"é¦¬å¯ç¦éŸ³å››ç« 30-41ç¯€"
  â†“
detectBibleQuery() - ç°åœ¨åº”è¯¥æ­£ç¡®è¯†åˆ«ä¸º verse query âœ…
  â†“
getBibleVerse(41, 4, "30-41") - 8ç§’è¶…æ—¶
  â†“
getWordAnalysis() + getCommentary() - å¹¶è¡Œï¼Œå„8ç§’è¶…æ—¶
  â†“
lookupStrongs() - å¤šä¸ªè°ƒç”¨ï¼Œå„8ç§’è¶…æ—¶
  â†“
AI API call with bible context - 25ç§’è¶…æ—¶
  â†“
æ€»æ—¶é—´ï¼š8 + 8 + 8 + 25 = 49ç§’ï¼ˆå¯èƒ½è¶…è¿‡ç½‘å…³é™åˆ¶ï¼‰
```

## è§£å†³æ–¹æ¡ˆ

### 1. âœ… å·²ä¿®å¤ï¼šä¸­æ–‡æ•°å­—æ”¯æŒ
- ç°åœ¨å¯ä»¥æ­£ç¡®è¯†åˆ«"å››ç« "æ ¼å¼
- é¿å…è¯¯åˆ¤ä¸º search query

### 2. âœ… å·²æ·»åŠ ï¼šè¯¦ç»†æ—¥å¿—
- è®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´
- å¸®åŠ©å®šä½ç“¶é¢ˆ

### 3. å»ºè®®ä¼˜åŒ–ï¼ˆå¦‚æœé—®é¢˜æŒç»­ï¼‰

#### A. å‡å°‘ Bible API è°ƒç”¨
```typescript
// å¯¹äº verse range (30-41)ï¼Œåªè·å–å…³é”®ç»æ–‡
// è€Œä¸æ˜¯æ‰€æœ‰ç›¸å…³æ•°æ®
if (verseRange.includes('-')) {
  // åªè·å–é¦–å°¾ç»æ–‡ + æ³¨é‡Š
  // è·³è¿‡ word analysis å’Œ Strong's lookup
}
```

#### B. å¢åŠ è¶…æ—¶æ—¶é—´
```typescript
// å¦‚æœç½‘å…³å…è®¸ï¼Œå¯ä»¥å¢åŠ è¶…æ—¶
const API_TIMEOUT = 30000; // 30 seconds
const BIBLE_API_TIMEOUT = 10000; // 10 seconds
```

#### C. ç®€åŒ– Bible Context
```typescript
// é™åˆ¶ Bible context é•¿åº¦
if (bibleContext.length > 5000) {
  bibleContext = bibleContext.substring(0, 5000) + "...";
}
```

## è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥éƒ¨ç½²æ—¥å¿—

```bash
curl "https://space.ai-builders.com/backend/v1/deployments/arkchat/logs?log_type=app" \
  -H "Authorization: Bearer $AI_BUILDER_TOKEN"
```

æŸ¥æ‰¾æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³ï¼š
- `[Xms] Request received`
- `[Xms] Bible query detection`
- `[Xms] Verse data fetched`
- `[Xms] Making AI API request`
- `[Xms] Chat API error`

### 2. è¯†åˆ«ç“¶é¢ˆ

æ ¹æ®æ—¥å¿—æ—¶é—´æˆ³ï¼Œæ‰¾å‡ºå“ªä¸ªæ­¥éª¤è€—æ—¶æœ€é•¿ï¼š
- Bible query detectionï¼šåº”è¯¥ < 10ms
- Verse fetchï¼šåº”è¯¥ < 8s
- Word analysis + Commentaryï¼šåº”è¯¥ < 8sï¼ˆå¹¶è¡Œï¼‰
- AI API callï¼šåº”è¯¥ < 25s

### 3. å¦‚æœæŸä¸ªæ­¥éª¤è¶…æ—¶

- **Verse fetch > 8s**ï¼šFHL API å“åº”æ…¢ï¼Œå¯èƒ½éœ€è¦é‡è¯•æˆ–è·³è¿‡
- **AI API > 25s**ï¼šAI Builder API å“åº”æ…¢ï¼Œå¯èƒ½éœ€è¦ç®€åŒ– context
- **æ€»æ—¶é—´ > 60s**ï¼šç½‘å…³è¶…æ—¶ï¼Œéœ€è¦ä¼˜åŒ–æ•´ä½“æµç¨‹

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•ä¿®å¤åçš„æ£€æµ‹**ï¼š
   ```
   è¼¸å…¥ï¼šé¦¬å¯ç¦éŸ³å››ç« 30-41ç¯€
   é æœŸï¼šæ­£ç¢ºè­˜åˆ¥ç‚º verse queryï¼Œbook=é¦¬å¯ç¦éŸ³, chapter=4, verse=30-41
   ```

2. **ç›‘æ§æ—¥å¿—**ï¼š
   - æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´
   - ç¡®è®¤æ²¡æœ‰ä¸å¿…è¦çš„ API è°ƒç”¨

3. **å¦‚æœä»æœ‰è¶…æ—¶**ï¼š
   - æ£€æŸ¥æ—¥å¿—ä¸­çš„æ—¶é—´æˆ³
   - æ‰¾å‡ºæœ€æ…¢çš„æ­¥éª¤
   - æ ¹æ®ç“¶é¢ˆä¼˜åŒ–

## ä¸‹ä¸€æ­¥

1. âœ… ä»£ç å·²æ›´æ–°ï¼ˆä¸­æ–‡æ•°å­—æ”¯æŒ + è¯¦ç»†æ—¥å¿—ï¼‰
2. â³ ç­‰å¾…éƒ¨ç½²å®Œæˆ
3. ğŸ“Š æµ‹è¯•å¹¶æŸ¥çœ‹æ—¥å¿—
4. ğŸ”§ æ ¹æ®æ—¥å¿—ç»“æœè¿›ä¸€æ­¥ä¼˜åŒ–
